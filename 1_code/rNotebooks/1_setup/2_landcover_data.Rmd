
```{r setup, include=FALSE, cache=FALSE}
#Set root directory to R project root
knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file())
```



```{css, echo=FALSE}
# set max height of code chunks using the following css styling

pre {
  max-height: 300px;
  overflow-y: auto;
}

pre[class] {
  max-height: 500px;
}
```


```{r eval=FALSE}
library(dplyr)
library(stringr)
library(tmaptools)
library(tmap)
library(sf)
library(raster)
library(lubridate)
```



### CAS-FRI data {-}

#### Load CAS-FRI polygons {-}

Read ESRI geodatabase containing CAS-FRI, using sf package 


```{r eval=FALSE, echo=FALSE}
#  see layers in ESRI geodatabase

l<-st_layers(dsn="../../data/spatial/external/CASFRI/Alberta/alberta_geo.gdb")
l

# Driver: OpenFileGDB 
# Available layers:
#              layer_name geometry_type features fields
# 1           alberta_geo Multi Polygon  2632003     17
# 2     Alberta_dst_CO_25            NA       96      5
# 3     Alberta_dst_CO_50            NA      249      5
# 4     Alberta_dst_CO_95            NA     1684      5
# 5     Alberta_dst_CO_75            NA      395      5
# 6    Alberta_dst_CO_100            NA    22952      5
# 7 Alberta_dst_CO_DistRd Multi Polygon    14166      8
# 8   alberta_geo_project Multi Polygon  2631185      3



#Load alberta_geo (the CAS-FRI polygons)

cas_geo<-st_read(dsn="../../data/spatial/external/CASFRI/Alberta/alberta_geo.gdb", layer="alberta_geo")

cas_geo<-cas_geo[,1]


save(cas_geo, file="0_data/manual/CASFRI/cas_geo.rData")
```



#### Clip CAS-FRI to study area {-}

```{r eval=FALSE}
# load cas_geo
load("0_data/manual/spatialCov/CASFRI/cas_geo.rData")

# load study area
load("0_data/manual/bird/studyarea_big.rData")

#repair geometry of cas_geo
cas_geo1<-st_make_valid(cas_geo)

c_bb_tr<-st_transform(c_bb, st_crs(cas_geo1))
c_bb_tr_2<-st_bbox(c_bb_tr)
cas_geo_crop<-st_crop(cas_geo1, c_bb_tr_2)


# cas_geo_clip<-st_intersection(cas_geo, c_bb_tr)
cas_geo_crop_tr<-st_transform(cas_geo_crop, st_crs(c_bb))

cas_geo_crop_tr_1<-projectRaster(cas_geo_crop, crs = st_crs(c_bb)$proj4string)
test<-raster::projectRaster(cas_geo_crop, crs = projection(alberta))

cas_geo_crop<-cas_geo_crop[1]

cas_geo_crop<-st_buffer(cas_geo_crop, 0.0)
save(cas_geo_crop, file="0_data/manual/spatialCov/CASFRI/cas_geo_crop.rData")

##############################################################################
##Plot the clipped CAS-FRI polygons

#set up basemap
base<-read_osm(c_bb, type="bing", minNumTiles = 10)

# stations
load("0_data/manual/bird/ss_xy.rData")

#alberta boundary
alberta<-st_read("../../data/spatial/external/Alberta_Boundaries_and_Roads/Alberta/Alberta.shp")



mainmap<-tm_shape(base)+
  tm_rgb(alpha=.8)+ # to color the satelite basemap
  # tm_shape(c_bb)+
  # tm_fill(col="white", alpha=.7)+
  tm_shape(cas_geo_crop)+
  tm_borders(col="black")+
  tm_shape(ss_xy)+
    tm_symbols(shape = 4, alpha = 1, size = .6, col = "red")+
  tm_scale_bar(position=c("left", "BOTTOM"), text.color = "black", color.light="lightgrey")+
  tm_graticules(lines=FALSE)+
  tm_legend(outside=TRUE)

insetmap<-tm_shape(alberta)+tm_fill(col="lightgrey")+tm_borders(lwd=.9, col="black")+
  tm_shape(c_bb)+tm_borders(lw=2, col="red") +
  tm_layout(inner.margins = c(0.04,0.04,0.04,0.04), outer.margins=c(0,0,0,0), bg.color="transparent", frame = FALSE)
    #tm_symbols(shape = 20, alpha = .5, border.col="dimgray", size = .1, col = "black")
  #tm_legend(position=c("left", "top"), frame=TRUE)

#Get aspect ratio of bounding box
c_bb_2<-st_bbox(c_bb)
asp <- (c_bb_2$ymax - c_bb_2$ymin)/(c_bb_2$xmax - c_bb_2$xmin)


library(grid)
w <- 1
h <- asp * w
vp <- viewport(0.7, 0.33, width = w, height=h)
#vp <- viewport(0.9, 0.22, width = w, height=h, just=c("right", "top"))

tmap_save(mainmap,filename="3_output/maps/casfri_inset.png",
          dpi=300, insets_tm=insetmap, insets_vp=vp,
          height=asp*350, width=350, units="mm")
```

```{r map_fCASFRI_plot, echo=FALSE, fig.cap= "CASFRI landcover polygons", out.width = '100%'}
knitr::include_graphics("3_output/maps/casfri_inset.png")
```

#### Add LiDAR acquistion date to CAS_FRI polygons
```{r eval=FALSE}
acqDate<-st_read("../../data/spatial/external/Alberta_Landcover_Data/LiDAR/GOA_LiDAR_Alberta/from_ChrisBater/lidar_acquisitions/acquisition_date.shp")

acqDate<-st_transform(acqDate, crs = st_crs(cas_geo_crop))
cas_geo_crop_lidarDate<-st_join(cas_geo_crop,acqDate)
cas_geo_crop_lidarDate$date-as.Date(cas_geo_crop_lidarDate$date)
cas_geo_crop_lidarDate$year<-year(cas_geo_crop_lidarDate$date)

save(cas_geo_crop_lidarDate, file="0_data/manual/spatialCov/CASFRI/cas_geo_crop_lidarDate.rData")
```


#### Spatial join point count locations with CAS-FRI polygons {-}


```{r eval=FALSE}
#load clipped cas-fri polygons
load("0_data/manual/spatialCov/CASFRI/cas_geo_clip.rData")
# load point count locations
load("0_data/manual/bird/ss_xy.rData")

#transform crs of station locations to match the CAS-FRI polygons
ss_xy_tr<-st_transform(ss_xy, st_crs(cas_geo))

#add CAS-FRI ids to station data
ss_xy_cas<-st_join(ss_xy_tr, cas_geo)
# transform back to original crs
ss_xy_tr<-st_transform(ss_xy_cas, st_crs(ss_xy))


save(ss_xy_cas, file ="0_data/manual/spatialCov/CASFRI/ss_xy_cas.rData")

```

#### Or...bring in cas-fri station data from another chapter {-}

```{r eval=FALSE}
load("../../chapter_3/empirical/2_pipeline/tmp/bd_xy_cas.rData")
load("0_data/manual/bird/ss_xy.rData")

test<-left_join(as.data.frame(ss_xy), as.data.frame(bd_xy_cas), by="SS")

x<-as.data.frame(ss_xy)%>%
  select(SS)
y<-as.data.frame(bd_xy_cas)%>%
  select(SS, cas_id)

ss_cas<-left_join(x, y)
save(ss_cas, file ="0_data/manual/spatialCov/CASFRI/ss_cas.rData")

```

```{r echo=FALSE, message = FALSE, results="asis"}
load("0_data/manual/spatialCov/CASFRI/ss_cas.rData")

knitr::kable(head(ss_cas)) %>%
  kable_styling(font_size = 10, bootstrap_options= c("striped", "hover", "condensed" ), full_width= F, position="center") %>%
  column_spec(1, width= "20em")%>%
  scroll_box(width = "100%", height = "400px")
```




#### extract data on stand age and disturbance history {-}

```{r eval=FALSE}
###################################
# load disturbance data
###################################
cas_dst<-read.csv("../../data/spatial/external/CASFRI/Alberta/alberta_dst.csv")
#filter to only first layer
cas_dst<-filter(cas_dst, layer=="1")

###################################
# load forest data 
###################################
cas_lyr<-read.csv("../../data/spatial/external/CASFRI/Alberta/alberta_lyr.csv")
#filter to only first layer
cas_lyr<-filter(cas_lyr, layer=="1" & layer_rank=="1")

#forest type
   c#filter to only first layer
cas_forestType<-cas_forestType%>%
  rename(cas_id=Expr1)


###################################
# Join CASFRI covariates into a single data frame
###################################
cas_cov<-left_join(cas_lyr, cas_forestType,  by="cas_id")
cas_cov<-left_join(cas_cov, cas_dst, by="cas_id")

#change missing tree/forest type values to NA
d2<-cas_cov

d2[ d2 == -1111 ] <- NA 
d2[ d2 == -8888 ] <- NA 
#d2[29:47][ d2[28:46] == "XXXX MISS" ] <- NA     

d2$PercentDecid[ d2$Forest_Type == "" ] <- NA
d2$PercentConif[ d2$Forest_Type == "" ] <- NA
d2$Forest_Type[ d2$Forest_Type == "" ] <- NA

d2$dist_ext_upper_1<-as.factor(d2$dist_ext_upper_1)
d2$dist_ext_upper_2<-as.factor(d2$dist_ext_upper_2)


cas_cov<-d2

###################################
# Filter to calling lake
###################################     
ss_cas_cov<-left_join(ss_cas, cas_cov)

save(cas_cov, file="0_data/manual/spatialCov/CASFRI/cas_cov.rData")
save(ss_cas_cov, file="0_data/manual/spatialCov/CASFRI/ss_cas_cov.rData")
```

```{r echo=FALSE, message = FALSE, results="asis"}
load("0_data/manual/spatialCov/CASFRI/cas_cov.rData")

knitr::kable(head(cas_cov)) %>%
  kable_styling(font_size = 10, bootstrap_options= c("striped", "hover", "condensed" ), full_width= F, position="center") %>%
  column_spec(1, width= "20em")%>%
  scroll_box(width = "100%", height = "400px")
```




##### Load pointcount data {-}

```{r eval=FALSE}
load("0_data/manual/bird/bird_callingLake_wide_5.rData")
pkey_cas_cov<-bird_callingLake_wide_5%>%
  select(SS, PKEY, ss_year) %>%
  left_join(ss_cas_cov)
```

##### calculate forest age at time of LiDAR {-}
```{r}
cas_lyr<-read.csv("../../data/spatial/external/CASFRI/Alberta/alberta_lyr.csv")
cas_dst<-read.csv("../../data/spatial/external/CASFRI/Alberta/alberta_dst.csv")

cas_lyr2<-dplyr::filter(cas_lyr, layer=="1" & layer_rank=="1")%>%
  left_join(cas_dst)%>%
  mutate(forest_origin_year=coalesce(origin_upper, dist_yr_1))%>%
  dplyr::select(cas_id, forest_origin_year, dist_1)

load("0_data/manual/spatialCov/CASFRI/cas_geo_crop_lidarDate.rData")

cas_geo_crop_lidarDate_age<-cas_geo_crop_lidarDate%>%
  left_join(cas_lyr2)%>%
  mutate(lidar_forest_age=year-forest_origin_year)

save(cas_geo_crop_lidarDate_age, file="0_data/manual/spatialCov/CASFRI/cas_geo_crop_lidarDate_age.rData")

```

###### Create forest age raster {-}

```{r eval=FALSE}
load("0_data/manual/spatialCov/CASFRI/cas_geo_crop_lidarDate_age.rData")



#create the extent and the raster
e <- extent(cas_geo_crop_lidarDate_age)

#use study area aspect ration to calculate ncol and nrow for raster: #h=0.4444444 * w 
r <- raster::raster(e, crs= st_crs(cas_geo_crop_lidarDate_age)$proj4string, resolution = c(10, 10)) 

#remove error values
lidar_forestAge<-cas_geo_crop_lidarDate_age%>%
  dplyr::filter(lidar_forest_age<300)

# vreate forest age raster using rasterize
lidar_forestAge_raster<-raster::rasterize(lidar_forestAge, r, 'lidar_forest_age')

# save raster
writeRaster(lidar_forestAge_raster, filename = "0_data/manual/spatialCov/CASFRI/lidar_forestAge_raster", format="GTiff", overwrite=T)

```


##### calculate forest age at time of survey {-}

Get forest origin dates

```{r eval=FALSE}
### add forest origin year to cas_geo
load("0_data/manual/spatialCov/CASFRI/cas_cov.rData")
load("0_data/manual/spatialCov/CASFRI/cas_geo_crop.rData")

origin<-cas_cov%>%
  dplyr::select(cas_id, origin_upper, dist_yr_1, dist_yr_2, dist_yr_3)%>%
  mutate(forest_origin_year=coalesce(origin_upper, dist_yr_1))%>% # if upper origin is NA and there was a disturbance, replace NA with disturbance year.
  dplyr::select(cas_id, forest_origin_year)

cas_geo_crop_originYr<-left_join(cas_geo_crop, origin)

#plot
##############################################################################
##Plot the clipped CAS-FRI polygons and color by forest age

# stations
load("0_data/manual/bird/ss_xy.rData")

#alberta boundary
alberta<-st_read("../../data/spatial/external/Alberta_Boundaries_and_Roads/Alberta/Alberta.shp")


#set up basemap
base<-read_osm(c_bb, type="bing", minNumTiles = 10)

mainmap<-tm_shape(base)+
  tm_rgb(alph=.8)+ # to color the satelite basemap
  tm_shape(cas_geo_crop_originYr)+
  tm_fill(col = "forest_origin_year", 
              style = "quantile",
              palette = "BuGn",
              legend.hist = TRUE) +
  #tm_fill(col="forest_origin_year")+
  tm_shape(ss_xy)+
    tm_symbols(shape = 4, alpha = 1, size = .6, col = "red")+
  tm_scale_bar(position=c("left", "BOTTOM"), text.color = "black", color.light="lightgrey")+
  tm_graticules(lines=FALSE)+
  tm_legend(outside=TRUE)

insetmap<-tm_shape(alberta)+tm_fill(col="lightgrey")+tm_borders(lwd=.9, col="black")+
  tm_shape(c_bb)+tm_borders(lw=2, col="red") +
  tm_layout(inner.margins = c(0.04,0.04,0.04,0.04), outer.margins=c(0,0,0,0), bg.color="transparent", frame = FALSE)
    #tm_symbols(shape = 20, alpha = .5, border.col="dimgray", size = .1, col = "black")
  #tm_legend(position=c("left", "top"), frame=TRUE)

#Get aspect ratio of bounding box
c_bb_2<-st_bbox(c_bb)
asp <- (c_bb_2$ymax - c_bb_2$ymin)/(c_bb_2$xmax - c_bb_2$xmin)


library(grid)
w <- .8
h <- asp * w
vp <- viewport(0.7, 0.3, width = w, height=h)

tmap_save(mainmap,filename="3_output/maps/casfri_forestYear_inset.png",
          dpi=300, insets_tm=insetmap, insets_vp=vp,
          height=asp*350, width=350, units="mm")

#####################################
## Rasterize origin year polygons
#####################################


#create the extent and the raster
e <- extent(cas_geo_crop_originYr)

#use study area aspect ration to calculate ncol and nrow for raster: #h=0.4444444 * w 
r <- raster::raster(e, crs= st_crs(cas_geo_crop_originYr)$proj4string, resolution = c(10, 10)) 

# convert cas_geo to raster
cas_geo_crop_originYr_raster<-raster::rasterize(cas_geo_crop_originYr, r, 'forest_origin_year')

# save raster
writeRaster(cas_geo_crop_originYr_raster, filename = "0_data/manual/spatialCov/CASFRI/cas_geo_crop_originYr_raster", format="GTiff", overwrite=T)

 writeRaster(x, filename=paste0('0_data/manual/spatialCov/LiDAR/LiDAR_mosaics/',bl[j]), format="GTiff",  overwrite=T) 

#change resolution of raster for printing
r10<-aggregate(cas_geo_crop_originYr_raster, fact=10)

mainmap<-tm_shape(c_bb)+
  tm_borders(col="white")+ # to color the satelite basemap
  tm_shape(r10)+
  tm_raster(style = "cont",title="Canopy relief ratio", breaks = NULL,
            palette = "BuGn")+
  tm_shape(ss_xy)+
    tm_symbols(shape = 4, alpha = 1, size = .6, col = "red")+
  tm_scale_bar(position=c("left", "BOTTOM"), text.color = "black", color.light="lightgrey")+
  tm_graticules(lines=FALSE)+
  tm_legend(outside=TRUE)

tmap_save(mainmap,filename="3_output/maps/cas_geo_crop_originYr_raster.png",
          dpi=300, insets_tm=insetmap, insets_vp=vp,
          height=asp*350, width=350, units="mm")
```


```{r map_fCASFRI_plot, echo=FALSE, fig.cap= "CASFRI landcover polygons colored by forest age.", out.width = '100%'}
knitr::include_graphics("3_output/maps/casfri_forestYear_inset.png")
```

```{r map_fCASFRI_plot, echo=FALSE, fig.cap= "CASFRI landcover forest age raster.", out.width = '100%'}
knitr::include_graphics("3_output/maps/cas_geo_crop_originYr_raster.png")
```



```{r eval=FALSE}
load("0_data/manual/spatialCov/CASFRI/pkey_cas_cov.rData")
pkey_cas_cov$poly_forest_age<-pkey_cas_cov$ss_year-pkey_cas_cov$origin_upper

#plot
##############################################################################
##Plot the clipped CAS-FRI polygons and color by forest age

load("0_data/manual/spatialCov/CASFRI/cas_geo_crop.rData")
#load("0_data/manual/spatialCov/CASFRI/pkey_cas_cov.rData")
x<-pkey_cas_cov%>%
  select(cas_id, forest_age, PKEY)%>%
  filter(forest_age>=0)

y<-inner_join(cas_geo_crop, x)

# stations
load("0_data/manual/bird/ss_xy.rData")

#alberta boundary
alberta<-st_read("../../data/spatial/external/Alberta_Boundaries_and_Roads/Alberta/Alberta.shp")



#set up basemap
base<-read_osm(c_bb, type="bing", minNumTiles = 10)

mainmap<-tm_shape(base)+
  tm_rgb(alph=.8)+ # to color the satelite basemap
  tm_shape(y)+
  tm_fill(col="forest_age")+
  tm_shape(ss_xy)+
    tm_symbols(shape = 4, alpha = 1, size = .6, col = "red")+
  tm_scale_bar(position=c("left", "BOTTOM"), text.color = "black", color.light="lightgrey")+
  tm_graticules(lines=FALSE)+
  tm_legend(outside=TRUE)

insetmap<-tm_shape(alberta)+tm_fill(col="lightgrey")+tm_borders(lwd=.9, col="black")+
  tm_shape(c_bb)+tm_borders(lw=2, col="red") +
  tm_layout(inner.margins = c(0.04,0.04,0.04,0.04), outer.margins=c(0,0,0,0), bg.color="transparent", frame = FALSE)
    #tm_symbols(shape = 20, alpha = .5, border.col="dimgray", size = .1, col = "black")
  #tm_legend(position=c("left", "top"), frame=TRUE)

#Get aspect ratio of bounding box
c_bb_2<-st_bbox(c_bb)
asp <- (c_bb_2$ymax - c_bb_2$ymin)/(c_bb_2$xmax - c_bb_2$xmin)


library(grid)
w <- 1
h <- asp * w
vp <- viewport(0.7, 0.33, width = w, height=h)
#vp <- viewport(0.9, 0.22, width = w, height=h, just=c("right", "top"))

tmap_save(mainmap,filename="3_output/maps/casfri_forestAge_inset.png",
          dpi=300, insets_tm=insetmap, insets_vp=vp,
          height=asp*350, width=350, units="mm")


```

```{r map_fCASFRI_plot, echo=FALSE, fig.cap= "CASFRI landcover polygons colored by forest age.", out.width = '100%'}

knitr::include_graphics("3_output/maps/casfri_forestAge_inset.png")
```

###### Extract stand origin date raster values to points

```{r eval=FALSE}

r<-raster("0_data/manual/spatialCov/CASFRI/cas_geo_crop_originYr_raster.tif")

ss_forest_origDate_mean<-extract(r,ss_xy, buffer=100, na.rm=TRUE, fun=mean)
save(ss_forest_origDate_mean, file="2_pipeline/tmp/ss_forest_origDate_mean.rData")

ss_forest_origDate_sd<-extract(r,ss_xy, buffer=100, na.rm=TRUE, fun=sd) 
save(ss_forest_origDate_sd, file="2_pipeline/tmp/ss_forest_origDate_sd.rData")

ss_forest_origDate_mean<-round(ss_forest_origDate_mean,0)
ss_forest_origDate_sd<-round(ss_forest_origDate_sd,2)

SS_forest_origDate_mean_sd<-as.data.frame(cbind(ss_xy, ss_forest_origDate_mean, ss_forest_origDate_sd))%>%
  dplyr::select(-geometry)

save(SS_forest_origDate_mean_sd, file="2_pipeline/tmp/SS_forest_origDate_mean_sd")
```

##### Calculate forest age based on mean raster values

```{r eval=FALSE}
x<-left_join(pkey_cas_cov, SS_forest_origDate_mean_sd)
x$rast_forest_age<-x$ss_year-x$ss_forest_origDate_mean
x<-x[c(1:5, 58, 36, 56:57, 7:35, 37:55)]

pkey_cas_cov<-x
pkey_cas_cov<-pkey_cas_cov[c(1:6, 38:39, 7:37, 40:57)]
```



##### calculate time since disturbance {-}

```{r eval=FALSE}
pkey_cas_cov$ss_dst_timelag<-pkey_cas_cov$ss_year-pkey_cas_cov$dist_yr_1

pkey_cas_cov<-pkey_cas_cov[c(1:2,4,3,54:55,5:53)]
save(pkey_cas_cov, file="0_data/manual/spatialCov/CASFRI/pkey_cas_cov.rData")
```


##### Calculate Forest age classes

0 0-9 stand initiation: shrub-herb
1 10-19 late stand initiation: sapling
2 20-33 early stem exclusion
3 33-80 late stem exclusion
4 80-99 early canopy transition
5 100+late canopy transition/gap dynamics


```{r}
load("0_data/manual/spatialCov/CASFRI/pkey_cas_cov.rData")

x<-pkey_cas_cov
hist(x$rast_forest_age)
x$forest_age_class_r <- cut(
  x$rast_forest_age,
  breaks = c(0, 10, 20, 34, 81, 100, Inf),
  labels = c("0", "1", "2", "3", "4", "5"),
  right  = FALSE
)
#plot(x$forest_age_class_r)

x$forest_age_class_p <- cut(
  x$poly_forest_age,
  breaks = c(0, 10, 20, 34, 81, 100, Inf),
  labels = c("0", "1", "2", "3", "4", "5"),
  right  = FALSE
)

#plot(x$forest_age_class_p)
#compare forest age class from polygons vs forest age class from raster
x1<-x[c(2,6, 58)]%>%
  rename(forest_age_class=forest_age_class_r)
x2<-x[c(2,59)]%>%
  rename(forest_age_class=forest_age_class_p)
aj<-anti_join(x1,x2)

pkey_cas_cov<-x

save(pkey_cas_cov, file="0_data/manual/spatialCov/CASFRI/pkey_cas_cov.rData")

```


### 2005 MODIS Landcover {-}

http://www.cec.org/north-american-environmental-atlas/land-cover-2005-modis-250m/


```{r eval=FALSE}
#use the modis landcover data extracted for the QPAD offsets.
load("../../data/avian_lifeHistory/BAM_avianDatabase/AB-data-w-offsets-to-Brendan.RData")

# use dd for the habitat covariates the offsets were based on
callingLake_QPAD_LC<-dd%>%filter(str_detect(PKEY, "^CL"))

save(callingLake_QPAD_LC, file="0_data/manual/spatialCov/QPAD/callingLake_QPAD_LC.rData")

```


### Oceanic Ni√±o Index (ONI) {-}

@lestonLongtermChangesBoreal2018

December January February
```{r eval=FALSE}
ONI<-read.csv("0_data/external/OceanicNinoIndex.csv")
```


